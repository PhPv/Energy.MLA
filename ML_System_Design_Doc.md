# ML System Design Doc - [RU]
## Дизайн ML системы - \<Продукт\> \<MVP or Production System\> \<Номер\>

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*   

- Рекомендации по процессу заполнения документа (workflow) - [здесь](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Workflow.md).  
- Детальный доклад о том, что такое ML System Design Doc и о том, как, когда и зачем его составлять - [тут](https://www.youtube.com/watch?v=PW9TGNr1Vqk).
    
> ## Термины и пояснения
> - Итерация - это все работы, которые совершаются до старта очередного пилота  
> - БТ - бизнес-требования 
> - EDA - Exploratory Data Analysis - исследовательский анализ данных  
> - `Product Owner`,  `Data Scientist` - роли, которые заполняют соответствующие разделы 
> - В этом шаблоне роль `Data Scientist` совмещает в себе компетенции классического `Data Scientist` с упором на исследования и `ML Engineer` & `ML Ops` роли с акцентом на продуктивизацию моделей
> - Для вашей организации распределение ролей может быть уточнено в зависимости от операционной модели 

### 1. Цели и предпосылки 
#### 1.1. Обоснованность разработки продукта

##### Бизнес-цель: 
- Увеличение выручки от продажи электроэнергии солнечными и ветряными электростанциями на рынке на сутки вперед оптового рынка электроэнергии
##### Побочная бизнес цель:
- Дополнительный продукт, показывающий потребность в DWH 

##### Пользова от внедрения ML модели
- Благодаря использованию машинного обучения можно будет учитывать параметры, напрямую влияющие на выработку электроэнергии

##### Критерии успеха
- Успехом будет являться рост выручки от продажи электроэнергии на рынке на сутки вперед
- Результаты модели сопоставимы и\или превышают результаты работы профильного специалиста (трейдера)
- Результаты, достигаемые трейдером с моделью превышают результаты трейдера без модели

- План минимум (для рынка РФ) среднесуточное значение ошибки прогноза модели должно быть ниже ошибки трейдера
$$dMAPE_{трейдер}≥dMAPE_{модель}$$

$$dMAPE=\frac{1}{N}\displaystyle\sum_{i=1}^{N}|{\frac{\hat{y_{i}}-y_{i}}{y_{i}}}|,$$

$N$ – общее количество торговых дней

$\hat{y}_{i}$ – фактически выработанная электроэнергия за день

$y_{i}$ – предсказанное значение выработки электроэнергии за день

- План максимум (для зарубежного рынка) среднечасовое значение ошибки прогноза модели должно быть ниже ошибки трейдера
$$MAPE_{трейдер}≥MAPE_{модель}$$

$$MAPE=\frac{1}{N}\displaystyle\sum_{i=1}^{N}|{\frac{\hat{y_{i}}-y_{i}}{y_{i}}}|,$$

$N$ – общее количество торговых дней

$\hat{y}_{i}$ – фактически выработанная электроэнергия за час

$y_{i}$ – предсказанное значение выработки электроэнергии за час

- Суммарные объемы продажи электроэнергии на РСВ, полученные благодаря использованию прогнозов модели, за рассматриваемый период (валидационной выборки) должны быть больше объемов трейдера
$$sum_{i=1}^{N}W_{модель}≥sum_{i=1}^{N}W_{трейдер}$$

$W$ – объем выработанной за день электроэнергии

#### 1.2. Бизнес-требования и ограничения  

##### Бизнес-процесс
- В течение торговых суток (Х+1) участники рынка-владельцы электростанций подают заявки, в которых указывают какой объем электроэнергии планируют к поставке на рынок на сутки вперед. 
- В операционные сутки электростанция вырабатывает столько электроэнергии, сколько это технически возможно
- Оплата поступает только за объемы электроэнергии, которые были указаны в заявке
- Если указанный ранее объем не закрыт - разность необходимо докупить на БР по рыночной цене.
- Если владалец электростанции превысил указанный ранее объем - излишки уходят на рынок за 1 рубль.

##### Бизнес-ограничения
**Целевое видение**
- Параллельно разрабатывает 3 направлениям силами отдельных специалистов
    - Прогноз на основе значений выработки и метеоданных
    - Прогноз на выработки и времянной зависимости 
    - Детекция облаков с помощью CV и вычисление площади затенения станции и интенсивность затенения
- Приоритетным является первое направление как наиболее эффективное.
- Второе и третье могут дать некоторый прирост к точности всего продукта и сформировать тем самым ансамбль моделей  

**Общие ограничения**
- Прогноз выработки необходимо делать на сутки вперед. 
- Проверить прогноз можно будет только на следующие сутки.
- Заявка должна быть сформирована и подана на рынок в течение торговых суток до 13:00 МСК 
- Модель должна оперировать более чем 1 источником метеоданных
- Модель должна легко масштабироваться с одного объекта на несколько объектов
- Должен формироваться отчет в формате, удобном для подачи заявки на рынок 
- Должна формироваться визуализация для удобного анализа результатов прогнозов
- Должен быть сформирован пайплайн обработки метеоданных
- Архивы метеоданных и метеопрогнозы платные
- Зимой станцию заметает снегом, сильно снижает качество данных
- Новые объекты не сразу выходят на установленную мощность
- Оборудование на объекте может выходить из строя
- Не всю информацию о работоспособности объекта можно получать в этот же день.
- В некоторых локациях погода может меняться за день (прогноз уже отправили, а погода поменялась)
- Объем датасета не менее 1 года, дискретизация не менее 1 часа
- Валидационная выборка не менее 20% от всего датасета
- Количество дней в валидационной выборке с объемами выработки электроэнергии не менее 80% максимально зарегестрированных - не менее половины (зимой объемы выработки небольшие, выручка маленькая, а вероятность ошибки прогноза намного выше)
- Для time-series направления прогноз дополнительно необходимо делать на несколько часов вперед
- Для CV направления прогноз необходимо делать только на несколько часов вперед 


**Ограничения для пилота**
- Достаточно прогноза для одного объекта (при достижении удовлетворительной точности)
- Достаточно прогноза на 1 источнике метеоданных (при достижении удовлетворительной точности)
- Достаточно прогноза для летних месяцев

 
**Ожидания от пилота**
- Проверка гипотезы, что с помощью машинного обучения на прогнозах погоды можно получить прогнозы выработки лучше, чем их получают трейдеры
- Полученная в рамках пилота модель будет работать параллельно, чтобы можно было сравнить результаты
- Критерий успеха пилота: схожая или более высокая точность прогнозов выработки по сравнению с трейдером

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- Выявление лучших (реализуемых) технологий машинного обучения для каждого из трех направлений
- Среднее значение dMAPE >= 85% на валидационной выработке на метеопрогнозе
- Выявление временнЫх зависимостей и интеграция их в основное решение (с приростом точности)
- Детекция облаков с прогнозом затенения площади станции и интеграция в основное решение (с приростом точности)

- Что не будет закрыто `Data Scientist`  
- Описание результата с точки зрения качества кода и воспроизводимости решения `Data Scientist`  

**Технический долг**
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации) `Data Scientist`  

#### 1.4. Предпосылки решения  

- Гипотеза, что можно спрогнозировать значения выработки электроэнергии на основе данных прогноза погоды, среди которых основными параметрами являются:
    - Значение солнечной радиации
        - Зависит от угла, под которым солнечные лучи падают на солнечную панель. Есть панели с трекерами, которые обеспечивают "прием" солнечных лучей под углом 90 градусов. На объектах в РФ, угол фиксированный. НЕ каждый метеосервис учитывет (и при этом правильно) данный аспект, поэтому полностью полагаться на значение радиации нельзя (иначе можно было бы всё расчитать по формуле)
        - Может поставлять источником данных в виде суммарного значение, а также в виде отдельных значений в разных плоскостях. 
        - Меняется в зависимости времени дня (суточная периодичность)
        - Меняется в зависимости времени года (сезонность)
    - Температура солнечных панелей
        - зависит от температуры окружающего воздуха
        - интенсивности работы (чем больше генерации, например днем, тем сильнее нагреваются)
        - скорости ветра (влияет на теплоотдачу)
        - чем холодней - тем выше эффективность и наоборот
- Для прогнозов на основе метеоданных разработана LightGBM модель на открытых данных с kaggle подтверждающая гипотезу 
- Есть гипотеза, что отдельная модель, работающая только с временнЫми зависимостями может поднять результаты основной модели, прогнозирующей на основе метеоданных
    - на периоде сутки вперёд
    - на периоде несколько часов вперёд (который будет уточнять прогноз на сутки вперед)
- Гипотеза, что прогнозируя площадь затенения станции можно поднять точность основной модели и второстепенной модели
    - 1. Детекция облака, его площади
    - 2. Расчет скорости его движения, траектории и изменения размеров
    - 3. Определение "густоты" облака (кучые дождевые облака затенят станцию на 100%, а прозрачные пористые облака из верхних слоёв атмосферы снизят выработку незначительно)
    - 4. Прогнозирование затеняемой им площади станции с учётом интенсивности затенения (например в виде интегрального показателя показывающего среднее значение затеняемого объекта)
    - 5. Использование полученного значения в прогнозе на несколько часов вперед (который будет его уточнять)
    - 6. Нужно учесть, что в основном метеопрогнозе уже учитывается облачность



Описание всех общих предпосылок решения, используемых в системе – с обоснованием от запроса бизнеса: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др. `Data Scientist`  

### 2. Методология `Data Scientist`     

#### 2.1. Постановка задачи  

- Работа с табличными данными, обладающими времянной зависимостью
- Прогнозирование на основе погодных данных
- Прогнозирование временнЫх рядов
- Детектирование облаков по снимкам спутников

#### 2.2. Блок-схема решения  
**Как-нибудь потом**
- Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение прогнозных моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое. `Data Scientist`  
- [Пример возможной блок схемы](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/product_schema.png?raw=true)
> Схема обязательно включает в себя архитектуру бейзлайна. Если бейзлайн и основной MVP отличаются несущественно, то это может быть одна блок-схема. Если значительно, то рисуем две: отдельно для бейзлайна, отдельно для основного MVP.  
> Если блок-схема **шаблонна** - т.е. её можно скопировать и применить к разным продуктам, то она **некорректна**. Блок-схема должна показывать схему решения для конкретной задачи, поставленной в части 1.    

#### 2.3. Этапы решения задачи `Data Scientist`  

- Для каждого этапа **по результатам EDA** описываем - **отдельно для бейзлайна** и **отдельно для основного MVP** - все про данные и технику решения максимально конкретно. Обозначаем необходимые вводные, технику предполагаемого решения и что ожидаем получить на выходе, чтобы перейти к следующему этапу.  
- Как правило, детальное и структурированное заполнение раздела `2.3` возможно только **по результатам EDA**.  
- Если описание в дизайн доке **шаблонно** - т.е. его можно скопировать и применить к разным продуктам, то оно **некорректно**. Дизайн док должен показывать схему решения для конкретной задачи, поставленной в части 1.  
    
> Примеры этапов:  
> - Этап 2 - Подготовка прогнозных моделей  
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)  
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества мрдели  
> - Этап 5 - Подготовка инференса модели по итерациям    
> - Этап 6 - Интеграция бизнес правил  
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)  
> - Этап 8 - Подготовка финального отчета для бизнеса  

**Этап - 1 подготовка и анализ данных**

Пример данных в репозитории. 
Табличные данные 
- fact.xls - матрица с target - Целевая переменная
- weather.xls - матрица с признаки
- тренировочный набор 10% от выборки
- валидационный набор 20% от выборки
- Необходимо
    - кросс-валидация на 5 блоках
    - поиск гиперпараметров (GridSearchCV)
Графические данные для CV:
- добавлю
- Анализ данных, выявление зависимостей
 
**Результат**
- обработанный датасет табличных данных, пригодный для обучения 
- скрипт обработки данных, являющийся прототипом для будущего пайплайна
- размеченные данные спутниковых снимков 
- результаты анализа данных, выявленные зависимости, закономерности

**Этап - 2 анализ технологий машинного обучения и выбор метрики**
  
- выявление эффективной техологии машинного обучения
    - для прогнозирования на табличных данных: LightGBM, XGBoost, CatBoost, решения основанные на нейронных сетях
    - для прогнозирования временнЫх рядов (ETNA)
    - для CV (ёлка?)
- выбор наиболее эффективной метрики из стандартных (rmse, mse, mape ...)

**Результат**
- выбранные библиотеки по прогнозированию
    - табличных данных
    - временнЫх рядов
    - CV
- выбранная метрика

**Этап - 3 Первая Итерация**
- для табличных данных с метеопрогнозом
    - применением кросс-валидации на не менее чем 5 блоках 
    - перебором гиперпараметров с помощью GridSearchCV (не менее 5)
    - При прогнозировании на основе метеоданных выяснить влияние shuffle=True на прогноз (возможно нет необходимости учитывать временную зависимость)
- для временной зависимости
- для CV 

**Результат**

**Этап - 4 Фич инжиниринг, кастомизация метрик, тюнинг гиперпараметров**
- на основе анализа данных и результатов первой итерации сгенерировать новые фичи
- создать кастомную метрику dMAPE 
- Интегрировать тюнинг гиперпараметров (optuna)

**Результат**

**Этап - 5 Вторая итерация обучения**

**Результат**

> Чаще всего заполнение раздела невозможно без EDA.

 *Этапы 2 и далее, помимо подготовки данных.*
 
Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  
### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group` 
  
#### 3.2. Что считаем успешным пилотом  
  
Формализованные в пилоте метрики оценки успешности `Product Owner`   
  
#### 3.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- Какая инфраструктура выбрана и почему `Data Scientist` 
- Плюсы и минусы выбора `Data Scientist` 
- Почему финальный выбор лучше других альтернатив `Data Scientist` 
  
#### 4.3. Требования к работе системы  
  
- SLA, пропускная способность и задержка `Data Scientist`  
  
#### 4.4. Безопасность системы  
  
- Потенциальная уязвимость системы `Data Scientist`  
  
#### 4.5. Безопасность данных   
  
- Нет ли нарушений GDPR и других законов `Data Scientist`  
  
#### 4.6. Издержки  
  
- Расчетные издержки на работу системы в месяц `Data Scientist`  
  
#### 4.5. Integration points  
  
- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`  
  
#### 4.6. Риски  
  
- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`   
  
> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.  
